# 運用ポリシー (Operation Policy)

本プロジェクトでは、インフラおよびアプリケーションの管理において「GitHubを唯一の正解（Single Source of Truth）」とする運用ポリシーを採用している。

---

## 目次

1. [基本指針](#1-基本指針)
2. [デプロイメント構造](#2-デプロイメント構造)
3. [なぜローカルからの apply を禁止するのか](#3-なぜローカルからの-apply-を禁止するのか)
4. [推奨される開発サイクル](#4-推奨される開発サイクル)

---

## 1. 基本指針

- **コードによる管理**: すべての設定（インフラ・アプリ）はGitHub上のコードで管理する。
- **自動化された実行**: AWSリソースへの変更（Terraform apply等）は、原則として個人のローカル環境ではなく、GitHub Actions等のCI/CDツールを介して実行する。
- **証跡の保持**: 「いつ」「誰が」「どのような理由で」変更したかをGitHubのコミット履歴とActionsのログに紐付けて管理する。

## 2. デプロイメント構造

役割に応じて、2つの異なるパイプラインを使い分ける。

### A. インフラ管理 (Terraform)
- **ツール**: GitHub Actions + ローカル実行
- **フロー**:
  - `dev`/`stg` ブランチ: マージ時に自動で `terraform plan` が実行される（適用はローカルで実施）。
  - `production` ブランチ: 手動発火のみ。GitHub Actions画面から手動で実行し、承認キーワード (`yes`) を入力した時のみ `terraform apply` が実行される。
- **メリット**: 
  - 開発・検証段階では変更内容の確認に集中でき、意図しない適用を防止。
  - 本番環境は厳格な承認プロセスを経て適用し、安全性を確保。

### B. アプリケーション管理 (App1 / App2)
- **ツール**: AWS CodePipeline (CodeStar Connection 連携)
- **フロー**:
  - 対象ブランチへのプッシュ/マージを AWS が直接検知し、ビルド（CodeBuild）からECSへのBlue/Greenデプロイまでを自動完結させる。
- **メリット**: GitHub Actions側に強いAWS権限（アクセスキー等）を持たせる必要がなく、AWSのネイティブ機能をフル活用した安全なデプロイが可能。

## 3. なぜローカルからの `apply` を禁止するのか

セキュリティと安定性の観点から、ローカルPCでの `terraform apply` やデプロイコマンドの実行は非推奨とする。

1. **資格情報の保護**: 個人のPCに強い権限のアクセスキーを保存する必要がなくなる（GitHub ActionsはOIDCによる一時認証を使用）。
2. **環境の整合性**: OSやツールのバージョンの違いによる「自分のPCでは動いた」という問題を排除できる。
3. **可視化**: ターミナルでの隠れた操作をなくし、チーム全員がデプロイ状況をGitHub上で一目で確認できるようにする。
4. **不慮の事故防止**: State（状態ファイル）の整合性が保たれ、意図しないリソース削除などのリスクを最小化する。

## 4. 推奨される開発サイクル

1. **ローカル環境**:
   - コードの編集、`terraform fmt`（フォーマット確認）、`terraform validate`（構文チェック）を行う。
2. **GitHubへのプッシュ/PR**:
   - 自動で `terraform plan` が実行され、差分を確認する。
3. **承認とマージ**:
   - 内容に問題がなければマージし、自動適用（dev/stg）または手動適用（prd）を行う。
