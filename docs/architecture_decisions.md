# アーキテクチャ選定理由 (Architecture Decision Records)

本ドキュメントでは、本プロジェクトにおける主要な技術選定の理由と、代替案との比較検討結果について記述する。

---

## 1. コンピュート基盤

### 選定技術: AWS ECS (Fargate)

#### なぜ EC2 ではないのか？
- **管理コストの最小化**: EC2 インスタンスの OS パッチ適用、エージェント更新、オートスケーリング設定などの「Undifferentiated Heavy Lifting（差別化につながらない重労働）」を削減するため。
- **セキュリティ**: ホスト OS へのアクセス権限管理や脆弱性対応が不要になるため。

#### なぜ EKS (Kubernetes) ではないのか？
- **運用負荷の適正化**: 現在の規模（マイクロサービス数個）では、Kubernetes クラスター自体のバージョン管理やエコシステムのメンテナンスコストが過大であると判断。
- **AWS 親和性**: ALB、IAM、CloudWatch などの AWS ネイティブサービスとの統合が最もシンプルかつ低コストで実現できるため。

#### なぜ App Runner ではないのか？
- **柔軟なネットワーク制御**: 単一の ALB 配下で `/app1`, `/app2` といったパスベースルーティングや、WAF による詳細なアクセス制御を実現するため。
- **Blue/Green デプロイの制御**: CodePipeline と連携し、テスト用ポートでの検証や待機時間（Bake Time）を含む安全なリリースフローを構築するため。
- **コスト最適化**: 開発環境での **Fargate Spot** 活用など、環境に応じたコスト戦略を細かく制御するため（後述）。

---

## 2. Infrastructure as Code (IaC)

### 選定技術: Terraform

#### なぜ CloudFormation / CDK ではないのか？
- **マルチ環境の効率的管理 (DRY)**: Modules 機能により、dev/stg/prd の 3 環境を単一のコードベースで管理し、環境差分を変数（tfvars）のみで制御する構成が容易であるため。
- **可読性と予測可能性**: HCL (HashiCorp Configuration Language) の宣言的な記述は可読性が高く、`terraform plan` によりデプロイ前の変更差分を確実に把握できるため。
- **エコシステム**: 将来的に Datadog、PagerDuty、GitHub などの AWS 以外の SaaS 設定も統合管理できる拡張性を評価。

---

## 3. デプロイメントパイプライン

### 選定技術: AWS CodePipeline + CodeBuild + CodeDeploy

#### なぜ GitHub Actions だけで完結させないのか？
- **ECS Blue/Green デプロイの実現**: ECS の高度なデプロイ機能（トラフィック制御、B/G デプロイ）は AWS CodeDeploy との連携が必須であるため。
- **セキュリティ**: デプロイ実行権限（IAM ロール）をGitHub 側に持たせず、AWS 内部（CodePipeline）で完結させることで、外部からの権限奪取リスクを軽減するため。

**採用した構成**:
- **GitHub Actions**: インフラの CI（Terraform Plan）、静的解析、ユニットテストを担当。
- **CodePipeline**: コンテナビルド、ECR プッシュ、および本番環境への安全なデプロイ（Blue/Green）を担当。

---

## 4. データベース

### 選定技術: Amazon RDS for PostgreSQL

#### なぜ Aurora ではないのか？
- **コストスモールスタート**: 開発環境や小規模フェーズにおいて、RDS (特に Graviton2/t4g インスタンス) の方がコストパフォーマンスに優れるため。
- **移行性**: PostgreSQL エンジンを使用しているため、将来的にパフォーマンス要件が高まった際は Aurora へ容易に移行可能。

#### なぜ DynamoDB ではないのか？
- **データ整合性**: アプリケーション要件として複雑なクエリやトランザクション、リレーショナルなデータ構造が必要であったため。

---

## 5. ロードバランサー

### 選定技術: Application Load Balancer (ALB)

#### なぜ NLB ではないのか？
- **L7 ルーティング**: 1つのドメインで複数のマイクロサービスへの振り分け（パスベースルーティング）が必要なため。
- **セキュリティ (WAF)**: AWS WAF を適用し、SQL インジェクションや XSS などの Web アプリケーション層の攻撃を防御するため。

---

## 6. シークレット管理

### 選定技術: AWS Secrets Manager

#### なぜ SSM Parameter Store ではないのか？
- **運用自動化**: RDS と統合された「パスワードの自動ローテーション」機能を利用可能なため。
- **セキュリティ**: アプリケーション側でパスワードを環境変数に埋め込まず、実行時に動的に取得または参照するセキュアな構成とするため。

---

## 7. コスト最適化戦略

本アーキテクチャでは、環境ごとに以下の構成を使い分けることで、可用性とコストのバランスを最適化している。

| 項目 | 開発環境 (dev) | 本番環境 (prd) | 選定理由 |
| :--- | :--- | :--- | :--- |
| **ECS Launch Type** | **Fargate Spot** | **Fargate** | dev は中断許容でコスト重視 (約70% OFF)、prd は安定性重視。 |
| **NAT Gateway** | **1 AZ** | **Multi-AZ (2)** | dev は冗長性不要でコスト削減、prd は可用性必須。 |
| **Database** | **Single-AZ** | **Multi-AZ** | データの耐久性要件の違い。 |
| **Logs** | **短期間 (7日)** | **長期間 (90日~)** | 監査および調査要件の違い。 |
